<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SCIndent</title>
<!--
    scindent.html
    2017-1-11 v1.51
-->
<style type="text/css">
<!--
.main_container {
    background-color: #fffca8; /* 背景色 */
    color: #000000;            /* 文字色 */
}
-->
</style>
<script type="text/javascript">
<!--
// ****************************************
//            ブラウザ関連処理等
// ****************************************

// ***** 汎用 *****
function Alm(msg) {
    // alert(msg);
}
function Alm2(msg) {
    alert(msg);
}
function DebugShow(msg) {
    document.getElementById("debug_show1").appendChild(document.createTextNode(msg));
}
function DebugShowClear() {
    document.getElementById("debug_show1").innerHTML = "";
}

// ***** 変換ボタン *****
function convert_button() {
    var ret;
    var src_st;
    var init_indent;
    var show_color;
    var show_paren_no;
    var result = {};

    // ***** 戻り値の初期化 *****
    ret = false;
    // ***** デバッグ表示の初期化 *****
    DebugShowClear();
    // ***** 要素の存在チェック *****
    if (!document.getElementById("src_text1"))     { Alm("convert_button:0001"); return ret; }
    if (!document.getElementById("init_indent"))   { Alm("convert_button:0002"); return ret; }
    if (!document.getElementById("show_color"))    { Alm("convert_button:0003"); return ret; }
    if (!document.getElementById("show_paren_no")) { Alm("convert_button:0004"); return ret; }
    if (!document.getElementById("out_text1"))     { Alm("convert_button:0005"); return ret; }
    if (!document.getElementById("result_show1"))  { Alm("convert_button:0006"); return ret; }
    if (!document.getElementById("no_change"))     { Alm("convert_button:0007"); return ret; }
    // ***** ソースの取得 *****
    src_st = document.getElementById("src_text1").value;
    init_indent = parseInt(document.getElementById("init_indent").value, 10);
    show_color = document.getElementById("show_color").checked;
    show_paren_no = document.getElementById("show_paren_no").checked;
    // ***** 変換実行 *****
    result = SCIndent.convert(src_st, init_indent, show_color, show_paren_no);
    // ***** 出力の表示 *****
    document.getElementById("out_text1").value = result.out;
    document.getElementById("result_show1").innerHTML = result.html;
    document.getElementById("no_change").style.display = (src_st == result.out) ? "block" : "none";
    // ***** 戻り値を返す *****
    ret = true;
    return ret;
}

// ***** クリアボタン *****
function clear_button() {
    var ret;

    // ***** 戻り値の初期化 *****
    ret = false;
    // ***** デバッグ表示の初期化 *****
    DebugShowClear();
    // ***** 要素の存在チェック *****
    if (!document.getElementById("src_text1"))    { Alm("clear_button:0001"); return ret; }
    if (!document.getElementById("out_text1"))    { Alm("clear_button:0002"); return ret; }
    if (!document.getElementById("result_show1")) { Alm("clear_button:0003"); return ret; }
    if (!document.getElementById("no_change"))    { Alm("clear_button:0004"); return ret; }
    // ***** ソースのクリア *****
    document.getElementById("src_text1").value = "";
    // ***** 出力のクリア *****
    document.getElementById("out_text1").value = "";
    document.getElementById("result_show1").innerHTML = "";
    document.getElementById("no_change").style.display = "none";
    // ***** 戻り値を返す *****
    ret = true;
    return ret;
}

// ***** サンプルボタン *****
function sample_button(sample_no) {
    var ret;
    var src_st;

    // ***** 戻り値の初期化 *****
    ret = false;
    // ***** 要素の存在チェック *****
    if (!document.getElementById("src_text1")) { Alm("sample_button:0001"); return ret; }
    // ***** ソースの設定 *****
    src_st = "";
    switch (sample_no) {
        case 0:
            src_st = "(if #t\n"
                + "'true\n"
                + "'false)\n";
            break;
        case 1:
            src_st = "(do ((i 1 (+ i 1)))\n"
                + "((> i 10) #f)\n"
                + "(print i))\n";
            break;
        case 2:
            src_st = ";; Newton's method\n"
                + "(define (mysqrt r)\n"
                + "(if (> r 0)\n"
                + "(let1 x0 (if (> r 1) r 1)\n"
                + "(let loop ((x1 x0) (x2 (/. (+ (/. r x0) x0) 2)))\n"
                + "(print x1 \" -> \" x2)\n"
                + "(if (> (- x1 x2) 1.0e-10)\n"
                + "(loop x2 (/. (+ (/. r x2) x2) 2))\n"
                + "x2)))\n"
                + "0))\n"
                + "(mysqrt 2)\n";
            break;
    }
    document.getElementById("src_text1").value = src_st;
    // ***** 変換ボタンを押したことにする *****
    convert_button();
    // ***** 戻り値を返す *****
    ret = true;
    return ret;
}


// ****************************************
//           Schemeインデント変換
// ****************************************

// ***** SCIndent(名前空間) *****
//
// 公開I/F :
//
//   SCIndent.convert(src_st, init_indent, show_color, show_paren_no)  変換実行
//     src_st         ソース(文字列)
//     init_indent    初期インデント(0-200)
//     show_color     色表示フラグ(boolean)
//     show_paren_no  括弧番号表示フラグ(boolean)
//     戻り値         結果オブジェクト
//                      result.out   テキスト出力(文字列)
//                      result.html  HTML出力(文字列)
//
var SCIndent;
(function (SCIndent) {
    // ***** 定数 *****
    var max_init_indent = 200; // 初期インデント最大値
    var max_str_size = 10000;  // 処理する文字数最大値

    var tab_size = 2;      // タブ幅
    var tab_char_size = 4; // タブ文字幅
    var keyword_table = {  // 構文キーワード
                           //   (値は構文のbodyの前の引数の数(負の数は特殊パターン))
        "begin":0,
        "case":1,
        // (defineで始まるものは無条件にキーワードとする)
        // "define":-1000,
        // "define-library":-1000,
        // "define-record-type":-1000,
        // "define-syntax":-1000,
        // "define-values":-1000,
        "delay":0,
        "do":2,
        "export":0,
        "if":1,
        "lambda":1,
        "let":1,
        "let*":1,
        "letrec":1,
        "letrec*":1,
        "library":1,
        "syntax-case":2,
        "with-input-from-file":1,
        "with-output-to-file":1,

        // Gauche (追加分)
        // (defineで始まるものは無条件にキーワードとする)
        // "define-class":-1000,
        // "define-condition-type":-1000,
        // "define-constant":-1000,
        // "define-dict-interface":-1000,
        // "define-in-module":-1000,
        // "define-macro":-1000,
        // "define-method":-1000,
        // "define-module":-1000,
        // "define-reader-ctor":-1000,
        "and-let1":2,
        "ecase":1,
        "glet1":2,
        // "hash-table":0,
        "hash-table":1,
        "if-let1":2,
        "match-lambda":0,
        "match-lambda*":0,
        "match-let1":2,
        "rlet1":2,
        "unwind-protect":1,

        // Gauche (http://karetta.jp/book-node/gauche-hacks/004682)
        "and-let*":1,
        "begin0":0,
        "call-with-client-socket":1,
        "call-with-input-conversion":1,
        "call-with-input-file":1,
        "call-with-input-process":1,
        "call-with-input-string":1,
        "call-with-iterator":1,
        "call-with-output-conversion":1,
        "call-with-output-file":1,
        "call-with-output-string":0,
        "call-with-temporary-file":1,
        "call-with-values":1,
        "dolist":1,
        "dotimes":1,
        "if-match":2,
        "let*-values":1,
        "let-args":2,
        "let-keywords*":2,
        "let-match":2,
        "let-optionals*":2,
        "let-syntax":1,
        "let-values":1,
        "let/cc":1,
        "let1":2,
        "letrec-syntax":1,
        "make":1,
        "multiple-value-bind":2,
        "match":1,
        "parameterize":1,
        "parse-options":1,
        "receive":2,
        "rxmatch-case":1,
        "rxmatch-cond":0,
        "rxmatch-if ":2,
        "rxmatch-let":2,
        "syntax-rules":1,
        "unless":1,
        "until":1,
        "when":1,
        "while":1,
        "with-builder":1,
        "with-error-handler":0,
        "with-error-to-port":1,
        "with-input-conversion":1,
        "with-input-from-port":1,
        "with-input-from-process":1,
        "with-input-from-string":1,
        "with-iterator":1,
        "with-module":1,
        "with-output-conversion":1,
        "with-output-to-port":1,
        "with-output-to-process":1,
        // "with-output-to-string":1,
        "with-output-to-string":0,
        "with-port-locking":1,
        "with-string-io":1,
        "with-time-counter":1,
        "with-signal-handlers":1,
        "with-locking-mutex":1,
        "guard":1 };
    var color_table = [           // 色テーブル(RGB)
        0x000000, 0x606060, 0xff4000, 0xa00000, 0xff00ff, 0x707000, 0x0000ff, 0x008080 ];
    var error_color   = 0xff0000; // エラー色(RGB)
    var comment_color = 0x008000; // コメント色(RGB)

    // ***** 変数 *****
    var src_st;        // ソース(文字列)
    var init_indent;   // 初期インデント(0-200)
    var show_color;    // 色表示フラグ(boolean)
    var show_paren_no; // 括弧番号表示フラグ(boolean)
    var out_st;        // テキスト出力(文字列)
    var html_st;       // HTML出力(文字列)
    var token = [];    // トークン(配列)
                       //   token[i].kind          種別(=0:改行,
                       //                               =1:開き括弧,
                       //                               =2:閉じ括弧,
                       //                               =3:クォート等の要素の前につく記号,
                       //                               =51:1行コメント,
                       //                               =52:複数行コメント,
                       //                               =53:S式コメント,
                       //                               =100:その他)
                       //   token[i].word          単語(文字列)
                       //   token[i].line_start    行頭フラグ(boolean)
                       //   token[i].line_no       行番号(1オリジン)
                       //   token[i].before_space  前方の空白数
                       //   token[i].paren_no      括弧番号
                       //   token[i].scmt_end      S式コメント終了フラグ(boolean)

    // ***** hasOwnPropertyをプロパティ名に使うかもしれない場合の対策 *****
    // (obj.hasOwnProperty(prop) を hasOwn.call(obj, prop) に置換した)
    var hasOwn = Object.prototype.hasOwnProperty;

    // ***** 公開I/F *****

    // ***** 変換実行 *****
    function convert(src_st1, init_indent1, show_color1, show_paren_no1) {
        var result = {}; // 戻り値

        // ***** 戻り値の初期化 *****
        result = {};
        result.out = "";
        result.html = "";
        // ***** 引数のチェック *****
        if (src_st1 == null)        { Alm("SCIndent.convert:0001"); return result; }
        if (init_indent1 == null)   { Alm("SCIndent.convert:0002"); return result; }
        if (show_color1 == null)    { Alm("SCIndent.convert:0003"); return result; }
        if (show_paren_no1 == null) { Alm("SCIndent.convert:0004"); return result; }
        // ***** ソースの取得 *****
        src_st = src_st1;
        // ***** 初期インデントの取得 *****
        init_indent = init_indent1 | 0;
        if (init_indent < 0) { init_indent = 0; }
        if (init_indent > max_init_indent) { init_indent = max_init_indent; }
        // ***** 色表示フラグの取得 *****
        show_color = show_color1;
        // ***** 括弧番号表示フラグの取得 *****
        show_paren_no = show_paren_no1;
        // ***** トークン分割 *****
        tokenize();
        // ***** インデント変換 *****
        make_indent();
        // ***** 出力の生成 *****
        make_output();
        // ***** 戻り値を返す *****
        result.out = out_st;
        result.html = html_st;
        return result;
    }
    SCIndent.convert = convert;

    // ***** 公開I/Fはここまで *****

    // ***** 以下は内部処理用 *****

    // ***** 出力の生成 *****
    function make_output() {
        var i;
        var token_len;       // トークン数
        var arr_st = [];     // 文字列の配列
        var span_open_count; // 閉じていないspanタグの数
        var scmt_count;      // S式コメントカウンタ

        // ***** テキスト出力の生成 *****
        out_st = "";
        arr_st = [];
        token_len = token.length;
        for (i = 0; i < token_len; i++) {
            // ***** 前方の空白を追加 *****
            if (token[i].kind != 0) {
                arr_st.push(make_space(token[i].before_space));
            }
            // ***** 単語を追加 *****
            arr_st.push(token[i].word);
        }
        out_st = arr_st.join("");

        // ***** HTML出力の生成 *****
        html_st = "";
        arr_st = [];
        span_open_count = 0;
        scmt_count = 0;
        token_len = token.length;
        for (i = 0; i < token_len; i++) {
            // ***** 前方の空白を追加 *****
            if (token[i].kind != 0) {
                arr_st.push(make_space(token[i].before_space));
            }
            // ***** 色設定を追加 *****
            if (show_color) {
                // ***** 開き括弧のとき *****
                if (token[i].kind == 1 && scmt_count <= 0) {
                    arr_st.push("<span style='color: " +
                        make_color_code(color_table[(token[i].paren_no + 2) % color_table.length]) + ";'>");
                    span_open_count++;
                // ***** 閉じ括弧が多すぎるとき *****
                } else if (token[i].kind == 2 && token[i].paren_no == 0) {
                    arr_st.push("<span style='color: " + make_color_code(error_color) + "; font-weight: bold;'>");
                    span_open_count++;
                // ***** コメントのとき *****
                } else if (token[i].kind >= 51 && token[i].kind <= 53) {
                    arr_st.push("<span style='color: " + make_color_code(comment_color) + ";'>");
                    span_open_count++;
                    if (token[i].kind == 53) { scmt_count++; }
                }
            }
            // ***** 単語をサニタイズ(タグ無効化)してから追加 *****
            arr_st.push(escape_html(token[i].word));
            // ***** 括弧番号を追加 *****
            if (show_paren_no) {
                if (token[i].kind == 1 || token[i].kind == 2) {
                    arr_st.push("=" + token[i].paren_no + "= ");
                }
            }
            // ***** 色設定の終了タグを追加 *****
            if (show_color) {
                // ***** 閉じ括弧のとき *****
                if (token[i].kind == 2 && scmt_count <= 0) {
                    arr_st.push("<\/span>");
                    span_open_count--;
                // ***** 閉じ括弧が多すぎるとき *****
                } else if (token[i].kind == 2 && token[i].paren_no == 0) {
                    arr_st.push("<\/span>");
                    span_open_count--;
                // ***** 1行コメントまたは複数行コメントのとき *****
                } else if (token[i].kind >= 51 && token[i].kind <= 52) {
                    arr_st.push("<\/span>");
                    span_open_count--;
                }
                // ***** S式コメント終了のとき *****
                if (token[i].scmt_end) {
                    arr_st.push("<\/span>");
                    span_open_count--;
                    scmt_count--;
                }
            }
        }
        // ***** 色設定の終了タグを追加 *****
        for (i = 0; i < span_open_count; i++) {
            arr_st.push("<\/span>");
        }
        html_st = arr_st.join("");

        // ***** デバッグ表示 *****
        if (0) {
            for (i = 0; i < token.length; i++) {
                DebugShow(JSON.stringify(token[i]) + "\n");
            }
        }
    }

    // ***** インデント変換 *****
    function make_indent() {
        var i;
        var j, j2, j3;
        var wd, wd2, wd3;     // 単語
        var token_len;        // トークン数
        var column_now;       // 現在行の文字数
        var pr = {};          // 括弧情報
                              //   pr.i            トークン位置
                              //   pr.paren_mode   括弧モード(=0:初期状態,=1:開き括弧,
                              //                              =2～:開き括弧後の要素があるごとに加算)
                              //   pr.column_base  開き括弧位置の文字数
                              //   pr.column_now   現在行の文字数
                              //   pr.indent_now   現在行のインデント
                              //   pr.indent_now2  現在行のインデント2(bodyの先頭が行頭にないときの対応用)
                              //   pr.keyword_val  構文キーワードの値
                              //                     (=-1:キーワードなし,
                              //                      = 0～:構文のbodyの前の引数の数,
                              //                      =-1000:特殊パターン(define))
                              //   pr.quote_flag   クォートフラグ(boolean)
                              //   pr.paren_last   括弧モードの処理済みチェック用
                              //   pr.scmt_count   S式コメントカウンタ
                              //   pr.line_start   行頭フラグ(bodyの先頭が行頭にないときの対応用)(boolean)
                              //   pr.let_flag     letフラグ(名前付きletの対応用)(boolean)
                              //   pr.proc_flag    手続き識別フラグ(boolean)
                              //
        var paren_stack = []; // 括弧情報のスタック(配列)
        var paren_no;         // 括弧番号(1オリジン)

        // ***** インデント変換 *****
        column_now = 0;
        pr = {};
        pr.i = 0;
        pr.paren_mode  = 0;
        pr.column_base = 0;
        pr.column_now  = 0;
        pr.indent_now  = init_indent;
        pr.indent_now2 = 0;
        pr.keyword_val = -1;
        pr.quote_flag  = false;
        pr.paren_last  = 0;
        pr.scmt_count  = 0;
        pr.line_start  = false;
        pr.let_flag    = false;
        pr.proc_flag   = false;
        paren_stack = [];
        paren_no = 1;
        token_len = token.length;
        for (i = 0; i < token_len; i++) {

            // ***** インデントの設定と文字数の計算 *****
            // ***** 行頭のとき *****
            if (token[i].line_start) {
                // ***** 複数行コメント以外のとき *****
                if (token[i].kind != 52) {
                    // ***** インデントを設定 *****
                    token[i].before_space = pr.indent_now;
                }
                // ***** 文字数を計算 *****
                column_now = token[i].before_space;
                pr.column_now = column_now;
            // ***** 行頭以外のとき *****
            } else {
                // ***** 文字数を計算 *****
                // (リテラル内の改行に対応)
                wd = token[i - 1].word;
                j = wd.length;
                j2 = wd.lastIndexOf("\r");
                j3 = wd.lastIndexOf("\n");
                if (j2 >= 0 || j3 >= 0) {
                    if (j2 >= j3) { j -= j2 + 1; } else { j -= j3 + 1; }
                    column_now = j + token[i].before_space;
                } else {
                    column_now += j + token[i].before_space;
                }
                pr.column_now = column_now;
            }

            // ***** トークンの解析 *****
            // ***** トークンの種別で場合分け *****
            switch (token[i].kind) {
                // ***** 改行のとき *****
                case 0:
                    break;
                // ***** 開き括弧のとき *****
                case 1:
                    // ***** 括弧モードの更新 *****
                    if (pr.paren_mode > 0 && !pr.quote_flag) {
                        pr.paren_mode++;
                        pr.line_start = token[i].line_start;
                    }
                    // ***** 括弧情報の追加 *****
                    paren_stack.push(pr);
                    pr = {};
                    pr.i = i;
                    pr.paren_mode  = 1;
                    pr.column_base = column_now;
                    pr.column_now  = column_now;
                    pr.indent_now  = column_now;
                    pr.indent_now2 = 0;
                    pr.keyword_val = -1;
                    pr.quote_flag  = false;
                    pr.paren_last  = 0;
                    pr.scmt_count  = 0;
                    pr.line_start  = false;
                    pr.let_flag    = false;
                    pr.proc_flag   = false;
                    // ***** 括弧番号の設定 *****
                    token[i].paren_no = paren_no;
                    paren_no++;
                    break;
                // ***** 閉じ括弧のとき *****
                case 2:
                    // ***** 対応する開き括弧のチェック *****
                    if (pr.paren_mode == 0 || pr.quote_flag) {
                        break;
                    }
                    wd = token[pr.i].word;
                    wd2 = wd.substring(wd.length - 1);
                    wd3 = token[i].word;
                    if (!((wd2 == "(" && wd3 == ")") || (wd2 == "[" && wd3 == "]") || (wd2 == "{" && wd3 == "}"))) {
                        break;
                    }
                    token[i].paren_no = token[pr.i].paren_no;
                    // ***** 括弧情報の削除 *****
                    pr = paren_stack.pop();
                    // ***** クォートフラグOFF *****
                    pr.quote_flag = false;
                    // ***** S式コメントの終了 *****
                    if (pr.scmt_count > 0) {
                        pr.scmt_count--;
                        token[i].scmt_end = true;
                    }
                    break;
                // ***** クォート等の要素の前につく記号のとき *****
                case 3:
                    // ***** 括弧モードの更新 *****
                    if (pr.paren_mode > 0 && !pr.quote_flag) {
                        pr.paren_mode++;
                        pr.line_start = token[i].line_start;
                    }
                    // ***** クォートフラグON *****
                    pr.quote_flag = true;
                    break;
                // ***** 1行コメントまたは複数行コメントのとき *****
                case 51:
                case 52:
                    break;
                // ***** S式コメントのとき *****
                case 53:
                    // ***** S式コメントの開始 *****
                    pr.scmt_count++;
                    // ***** クォートフラグON *****
                    pr.quote_flag = true;
                    break;
                // ***** その他のとき *****
                case 100:
                    // ***** 括弧モードの更新 *****
                    if (pr.paren_mode > 0 && !pr.quote_flag) {
                        pr.paren_mode++;
                        pr.line_start = token[i].line_start;
                    }
                    // ***** 開き括弧後の先頭の要素のとき *****
                    if (pr.paren_mode == 2 && !pr.quote_flag) {
                        // ***** 構文キーワードのとき *****
                        wd = token[i].word;
                        if (hasOwn.call(keyword_table, wd)) {
                            pr.keyword_val = keyword_table[wd];
                        }
                        // ***** defineのとき *****
                        // (defineで始まるものは無条件にキーワードとする)
                        if (wd.substring(0, 6) == "define") {
                            pr.keyword_val = -1000;
                        }
                        // ***** letのとき *****
                        if (wd == "let") {
                            pr.let_flag = true;
                        }
                    }
                    // ***** 名前付きletのとき *****
                    if (pr.let_flag && pr.paren_mode == 3 && !pr.quote_flag) {
                        pr.let_flag = false;
                        pr.keyword_val = 2;
                    }
                    // ***** 手続きのとき *****
                    if (token[pr.i].word.length == 1 && pr.paren_mode == 2) {
                        pr.proc_flag = true;
                    }
                    // ***** クォートフラグOFF *****
                    pr.quote_flag = false;
                    // ***** S式コメントの終了 *****
                    if (pr.scmt_count > 0) {
                        pr.scmt_count--;
                        token[i].scmt_end = true;
                    }
                    break;
            }

            // ***** インデントの計算 *****
            // ***** 開き括弧のとき *****
            if (pr.paren_mode == 1) {
                pr.indent_now = pr.column_base + token[pr.i].word.length;
            // ***** 開き括弧後のとき *****
            } else if (pr.paren_mode >= 2) {
                // ***** 手続きのとき *****
                if (pr.proc_flag) {
                    // ***** 構文キーワードありのとき *****
                    if (pr.keyword_val >= 0) {
                        // ***** 開き括弧後から2番目の要素までのとき *****
                        if (pr.paren_mode <= 3 && pr.paren_last < pr.paren_mode) {
                            pr.indent_now2 = pr.column_now;
                        }
                        // ***** 構文の引数の最後-1までのとき *****
                        if (pr.paren_mode < pr.keyword_val + 2) {
                            pr.indent_now = pr.column_base + tab_size * 2;
                        // ***** 構文の引数の最後のとき *****
                        } else if (pr.paren_mode == pr.keyword_val + 2) {
                            pr.indent_now = pr.column_base + tab_size;
                        // ***** 構文のbodyの先頭のとき *****
                        // (行頭でないときに動作を切り替える)
                        } else if (pr.paren_mode == pr.keyword_val + 3 && pr.paren_last < pr.paren_mode) {
                            if (!pr.line_start) {
                                pr.indent_now = pr.indent_now2;
                            } else {
                                pr.indent_now = pr.column_base + tab_size;
                            }
                        }
                        pr.paren_last = pr.paren_mode;
                    // ***** 構文キーワードあり(define)のとき *****
                    } else if (pr.keyword_val == -1000) {
                        pr.indent_now = pr.column_base + tab_size;
                    // ***** 構文キーワードなしのとき *****
                    } else {
                        // ***** 開き括弧後から2番目の要素までのとき *****
                        if (pr.paren_mode <= 3 && pr.paren_last < pr.paren_mode) {
                            pr.indent_now = pr.column_now;
                            pr.paren_last = pr.paren_mode;
                        }
                    }
                // ***** 手続き以外のとき *****
                } else {
                    // ***** 開き括弧後から先頭の要素までのとき *****
                    if (pr.paren_mode <= 2 && pr.paren_last < pr.paren_mode) {
                        pr.indent_now = pr.column_now;
                        pr.paren_last = pr.paren_mode;
                    }
                }
            }

        }
    }

    // ***** トークン分割 *****
    function tokenize() {
        var i;
        var i_start;      // 単語の開始位置
        var src_st_len;   // ソースの長さ
        var ch, ch2;      // 文字
        var line_start;   // 行頭フラグ(boolean)
        var line_no;      // 行番号(1オリジン)
        var line_no_tk;   // トークン開始時点の行番号
        var before_space; // 前方の空白数
        var uvector_mode; // ユニフォームベクタ解析モード
        var comment_nest; // 複数行コメントのネスト数
        var delim_ch;     // デリミタ文字
        var string_start; // 文字列開始フラグ(boolean)

        // ***** トークン追加 *****
        function token_push(kind, line_start_new) {
            var tk = {};
            // ***** トークン追加 *****
            tk.kind = kind;
            tk.word = src_st.substring(i_start, i);
            tk.line_start = line_start;
            tk.line_no = line_no_tk;
            tk.before_space = before_space;
            tk.paren_no = 0;
            tk.scmt_end = false;
            token.push(tk);
            // ***** フラグ等更新 *****
            line_start = line_start_new;
            before_space = 0;
        }

        // ***** トークン分割 *****
        token = [];
        i = 0;
        line_start = true;
        line_no = 1;
        before_space = 0;
        src_st_len = src_st.length;
        while (i < src_st_len) {
            // ***** 1文字取り出す *****
            i_start = i;
            line_no_tk = line_no;
            ch = src_st.charAt(i++);
            if (i < src_st_len) { ch2 = src_st.charAt(i); } else { ch2 = ""; }
            // ***** 空白のとき *****
            if (ch == " ") { before_space++; continue; }
            // ***** TABのとき *****
            if (ch == "\t") { before_space += tab_char_size; continue; }
            // ***** 改行のとき *****
            if (ch == "\r" || ch == "\n") {
                line_no++;
                if (ch == "\r" && ch2 == "\n") { i++; }
                token_push(0, true);
                continue;
            }
            // ***** 開き括弧のとき *****
            if (ch == "(" || ch == "[" || ch == "{") {
                token_push(1, false);
                continue;
            }
            // ***** 閉じ括弧のとき *****
            if (ch == ")" || ch == "]" || ch == "}") {
                token_push(2, false);
                continue;
            }
            // ***** ベクタの開き括弧のとき *****
            if (ch == "#" && ch2 == "(") {
                i++;
                token_push(1, false);
                continue;
            }
            // ***** ユニフォームベクタの開き括弧のとき *****
            if (ch == "#" && (
                ch2 == "f" || ch2 == "s" || ch2 == "u" ||
                ch2 == "F" || ch2 == "S" || ch2 == "U")) {
                i++;
                uvector_mode = 0;
                while (i < src_st_len) {
                    // ***** 1文字取り出す *****
                    ch = src_st.charAt(i);
                    // ***** 数値のとき *****
                    if (isDigit(ch)) {
                        i++;
                        uvector_mode = 1;
                        if (i >= i_start + 5) { break; }
                        continue;
                    }
                    // ***** 開き括弧のとき *****
                    if (ch == "(" && uvector_mode == 1) {
                        i++;
                        uvector_mode = 2;
                        break;
                    }
                    // ***** その他のとき *****
                    break;
                }
                // ***** 完成したとき *****
                if (uvector_mode == 2) {
                    token_push(1, false);
                    continue;
                }
                // ***** その他のとき(#fや#falseかもしれない) *****
                ch = "";
                ch2 = "";
                // (そのまま下におりてデリミタまでを登録)
            }
            // ***** クォートの開き括弧のとき *****
            if (ch == "'" && (ch2 == "(" || ch2 == "[" || ch2 == "{")) {
                i++;
                token_push(1, false);
                continue;
            }
            // ***** クォート等のとき *****
            if (ch == "'" || ch == "`" || ch == ",") {
                if (ch == "," && ch2 == "@") { i++; }
                token_push(3, false);
                continue;
            }
            // ***** アンインターンドシンボルまたはリーダ構築子構文のとき *****
            if (ch == "#" && (ch2 == ":" || ch2 == ",")) {
                i++;
                token_push(3, false);
                continue;
            }
            // ***** デバッグマクロのとき *****
            if (ch == "#" && ch2 == "?") {
                i++;
                if (i < src_st_len && src_st.charAt(i) == "=") {
                    i++;
                    token_push(3, false);
                    continue;
                }
                // ***** その他のとき *****
                ch = "";
                ch2 = "";
                // (そのまま下におりてデリミタまでを登録)
            }
            // ***** 1行コメントのとき *****
            if (ch == ";" || (ch == "#" && ch2 == "!")) {
                if (ch == "#" && ch2 == "!") { i++; }
                while (i < src_st_len) {
                    // ***** 1文字取り出す *****
                    ch = src_st.charAt(i);
                    // ***** 改行のとき *****
                    if (ch == "\r" || ch == "\n") { break; }
                    // ***** その他のとき *****
                    i++;
                }
                token_push(51, false);
                continue;
            }
            // ***** 複数行コメントのとき *****
            if (ch == "#" && ch2 == "|") {
                i++;
                comment_nest = 1;
                while (i < src_st_len) {
                    // ***** 1文字取り出す *****
                    ch = src_st.charAt(i++);
                    if (i < src_st_len) { ch2 = src_st.charAt(i); } else { ch2 = ""; }
                    // ***** 複数行コメント開始のとき *****
                    if (ch == "#" && ch2 == "|") { i++; comment_nest++; }
                    // ***** 複数行コメント終了のとき *****
                    if (ch == "|" && ch2 == "#") {
                        i++; comment_nest--;
                        if (comment_nest <= 0) { break; }
                    }
                    // ***** 改行のとき *****
                    if (ch == "\r" || ch == "\n") { line_no++; if (ch == "\r" && ch2 == "\n") { i++; } }
                }
                token_push(52, false);
                continue;
            }
            // ***** S式コメントのとき *****
            if (ch == "#" && ch2 == ";") {
                i++;
                token_push(53, false);
                continue;
            }
            // ***** シンボルまたは文字列のとき *****
            if (ch == "|" || ch == "\"") {
                delim_ch = ch;
                while (i < src_st_len) {
                    // ***** 1文字取り出す *****
                    ch = src_st.charAt(i++);
                    if (i < src_st_len) { ch2 = src_st.charAt(i); } else { ch2 = ""; }
                    // ***** エスケープのとき *****
                    if (ch == "\\" && (ch2 == "\\" || ch2 == delim_ch)) { i++; continue; }
                    // ***** デリミタのとき *****
                    if (ch == delim_ch) { break; }
                    // ***** 改行のとき *****
                    if (ch == "\r" || ch == "\n") { line_no++; if (ch == "\r" && ch2 == "\n") { i++; } }
                }
                token_push(100, false);
                continue;
            }
            // ***** 不完全文字列または補間文字列または旧補間文字列のとき *****
            if (ch == "#" && (ch2 == "*" || ch2 == "\"" || ch2 == "`")) {
                i++;
                string_start = true;
                if (ch2 == "*" || ch2 == "`") {
                    if (i < src_st_len && src_st.charAt(i) == "\"") {
                        i++;
                    } else {
                        string_start = false;
                    }
                }
                if (string_start == true) {
                    while (i < src_st_len) {
                        // ***** 1文字取り出す *****
                        ch = src_st.charAt(i++);
                        if (i < src_st_len) { ch2 = src_st.charAt(i); } else { ch2 = ""; }
                        // ***** エスケープのとき *****
                        if (ch == "\\" && (ch2 == "\\" || ch2 == "\"")) { i++; continue; }
                        // ***** デリミタのとき *****
                        if (ch == "\"") { break; }
                        // ***** 改行のとき *****
                        if (ch == "\r" || ch == "\n") { line_no++; if (ch == "\r" && ch2 == "\n") { i++; } }
                    }
                    token_push(100, false);
                    continue;
                }
                // ***** その他のとき *****
                ch = "";
                ch2 = "";
                // (そのまま下におりてデリミタまでを登録)
            }
            // ***** 文字集合または正規表現のとき *****
            if (ch == "#" && (ch2 == "[" || ch2 == "/")) {
                if (ch2 == "[") { delim_ch = "]"; } else { delim_ch = "/"; }
                i++;
                while (i < src_st_len) {
                    // ***** 1文字取り出す *****
                    ch = src_st.charAt(i++);
                    if (i < src_st_len) { ch2 = src_st.charAt(i); } else { ch2 = ""; }
                    // ***** エスケープのとき *****
                    if (ch == "\\" && (ch2 == "\\" || ch2 == delim_ch)) { i++; continue; }
                    // ***** デリミタのとき *****
                    if (ch == delim_ch) {
                        // ***** 正規表現の末尾にiがあるとき *****
                        if (ch == "/" && ch2 == "i") { i++; }
                        break;
                    }
                    // ***** 改行のとき *****
                    if (ch == "\r" || ch == "\n") { line_no++; if (ch == "\r" && ch2 == "\n") { i++; } }
                }
                token_push(100, false);
                continue;
            }
            // ***** 文字リテラルのとき *****
            if (ch == "#" && ch2 == "\\") {
                i++;
                if (i < src_st_len) {
                    // ***** 1文字取り出す *****
                    ch = src_st.charAt(i);
                    // ***** 記号文字のとき *****
                    if ("|()\";[]{}\\#".indexOf(ch) >= 0) {
                        i++;
                        token_push(100, false);
                        continue;
                    }
                    // ***** その他のとき *****
                    i++;
                }
                // ***** その他のとき *****
                ch = "";
                ch2 = "";
                // (そのまま下におりてデリミタまでを登録)
            }
            // ***** その他のとき *****
            while (i < src_st_len) {
                // ***** 1文字取り出す *****
                ch = src_st.charAt(i);
                // ***** デリミタのとき *****
                if (" \t\r\n|()\";[]{}\\#'`,".indexOf(ch) >= 0) { break; }
                // ***** その他のとき *****
                i++;
            }
            token_push(100, false);
        }
    }

    // ***** 空白文字列を作る *****
    function make_space(count) {
        var add_st = " ";
        var result_st = "";
        count |= 0;
        if (!(count > 0 && count <= max_str_size)) { return result_st; }
        while (true) {
            if (count & 1) { result_st += add_st; }
            count >>= 1;
            if (count) { add_st += add_st; } else { break; }
        }
        return result_st;
    }

    // ***** 色コード文字列を作る *****
    function make_color_code(color) {
        var result_st;
        result_st = "000000" + color.toString(16);
        result_st = "#" + result_st.substring(result_st.length - 6);
        return result_st;
    }

    // ***** HTML文字列のエスケープ処理 *****
    function escape_html(html_st) {
        return html_st
            .replace(/&/g,   "&amp;")
            .replace(/[<]/g, "&lt;")
            .replace(/>/g,   "&gt;")
            .replace(/"/g,   "&quot;")
            .replace(/'/g,   "&#39;");
    }

    // ***** 数値チェック *****
    function isDigit(ch) {
        // if (ch.match(/^[0-9]+$/)) { return true; }
        var c = ch.charCodeAt(0);
        if (c >= 0x30 && c <= 0x39) { return true; }
        return false;
    }


})(SCIndent || (SCIndent = {}));


// -->
</script>
</head>

<body class="main_container">

<form action="#" onsubmit="convert_button(); return false;">
<table width="95%"><tr>
<th align="center" colspan="3">SCIndent</th>
</tr><tr>
<th align="left" valign="top">src:</th>
<th align="left" width="95%"><textarea id="src_text1" cols="40" rows="10" style="width: 100%;"></textarea></th>
<th></th>
</tr><tr>
<th></th>
<th align="left"><input type="submit" value="convert"> &nbsp;
<input type="button" value="clear" onclick="clear_button();"> &nbsp;
initial indent : <input type="text" id="init_indent" value="0" style="width: 50px;"> &nbsp;
<input type="checkbox" id="show_color" checked>color &nbsp;
<input type="checkbox" id="show_paren_no">paren no.</th>
<th></th>
</tr><tr>
<th align="left" valign="top">out:</th>
<th align="left" width="95%"><textarea id="out_text1" cols="40" rows="10" style="width: 100%;"></textarea></th>
<th></th>
</tr><tr>
<th></th>
<th align="left"><input type="button" value="sample1" onclick="sample_button(0);">
<input type="button" value="sample2" onclick="sample_button(1);">
<input type="button" value="sample3" onclick="sample_button(2);"></th>
<th></th>
</tr></table>
<div id="no_change" style="display: none;"><br><b>[ no change ]</b></div>
<pre><span id="debug_show1"></span></pre>
<pre><span id="result_show1"></span></pre>
</form>

</body>
</html>
